name: Update Plugin Zips

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'extrafanart_gallery/**'
      - 'merge_multipart_vr/**'
      - 'performer_name_sync/**'

jobs:
  rezip:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2   # need HEAD and HEAD~1 to detect changed files

      - name: Detect changed plugin directories
        id: changed
        run: |
          PLUGINS=""
          for dir in extrafanart_gallery merge_multipart_vr performer_name_sync; do
            if git diff --name-only HEAD~1 HEAD | grep -q "^${dir}/"; then
              PLUGINS="${PLUGINS} ${dir}"
            fi
          done
          echo "plugins=${PLUGINS}" >> "$GITHUB_OUTPUT"
          echo "Changed plugins:${PLUGINS}"

      - name: Re-zip changed plugins (files at root, no wrapper folder)
        if: steps.changed.outputs.plugins != ''
        run: |
          for plugin in ${{ steps.changed.outputs.plugins }}; do
            echo "Zipping ${plugin}..."
            # cd into the plugin dir so zip entries have no leading folder
            (cd "${plugin}" && zip -r "../${plugin}.zip" .)
            echo "Created ${plugin}.zip"
          done

      - name: Commit and push updated zips
        if: steps.changed.outputs.plugins != ''
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          CHANGED_ZIPS=""
          for plugin in ${{ steps.changed.outputs.plugins }}; do
            git add "${plugin}.zip"
            CHANGED_ZIPS="${CHANGED_ZIPS} ${plugin}.zip"
          done

          if git diff --cached --quiet; then
            echo "No zip changes to commit."
          else
            git commit -m "chore: update zips for${{ steps.changed.outputs.plugins }} [skip ci]"
            git push
          fi
