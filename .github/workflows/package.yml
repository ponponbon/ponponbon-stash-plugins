name: package-plugin

on:
  push:
    branches:
      - main
    paths:
      - 'merge_multipart_vr/**'
      - 'extrafanart_gallery/**'
      - 'performer_name_sync/**'

jobs:
  detect:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, 'ci: auto-package')"
    outputs:
      plugins: ${{ steps.detect.outputs.plugins }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changed plugins
        id: detect
        run: |
          CHANGED=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || git show --name-only --format="" HEAD)
          echo "Changed files:"
          echo "$CHANGED"

          PLUGINS="[]"

          if echo "$CHANGED" | grep -q '^merge_multipart_vr/'; then
            PLUGINS=$(echo "$PLUGINS" | python3 -c "import sys,json; p=json.load(sys.stdin); p.append({'folder':'merge_multipart_vr','id':'merge_multipart','zip':'merge_multipart.zip','yml':'merge_multipart_vr/merge_multipart_vr.yml'}); print(json.dumps(p))")
            echo "Detected: merge_multipart_vr"
          fi

          if echo "$CHANGED" | grep -q '^extrafanart_gallery/'; then
            PLUGINS=$(echo "$PLUGINS" | python3 -c "import sys,json; p=json.load(sys.stdin); p.append({'folder':'extrafanart_gallery','id':'extrafanart_gallery','zip':'extrafanart_gallery.zip','yml':'extrafanart_gallery/extrafanart_gallery.yml'}); print(json.dumps(p))")
            echo "Detected: extrafanart_gallery"
          fi

          if echo "$CHANGED" | grep -q '^performer_name_sync/'; then
            PLUGINS=$(echo "$PLUGINS" | python3 -c "import sys,json; p=json.load(sys.stdin); p.append({'folder':'performer_name_sync','id':'performer_name_sync','zip':'performer_name_sync.zip','yml':'performer_name_sync/performer_name_sync.yml'}); print(json.dumps(p))")
            echo "Detected: performer_name_sync"
          fi

          COUNT=$(echo "$PLUGINS" | python3 -c "import sys,json; print(len(json.load(sys.stdin)))")
          echo "Total plugins to package: $COUNT"

          if [ "$COUNT" -eq 0 ]; then
            echo "No recognised plugin folder changed."
            exit 1
          fi

          echo "plugins=$PLUGINS" >> $GITHUB_OUTPUT

  package:
    needs: detect
    runs-on: ubuntu-latest
    strategy:
      matrix:
        plugin: ${{ fromJson(needs.detect.outputs.plugins) }}
      max-parallel: 1
    steps:
      - name: Checkout latest
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Pull latest (in case previous matrix job pushed)
        run: |
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"
          git pull --rebase origin main || true

      - name: Get short hash
        id: hash
        run: echo "sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Get and increment version
        id: version
        run: |
          CURRENT=$(grep '^version:' "${{ matrix.plugin.yml }}" | sed 's/version: *//' | tr -d '"' | cut -d'-' -f1)
          MAJOR=$(echo $CURRENT | cut -d'.' -f1)
          MINOR=$(echo $CURRENT | cut -d'.' -f2)
          PADLEN=${#MINOR}
          MINOR=$((10#$MINOR + 1))
          NEW_MINOR=$(printf "%0${PADLEN}d" $MINOR)
          echo "version=${MAJOR}.${NEW_MINOR}" >> $GITHUB_OUTPUT

      - name: Zip plugin
        run: |
          cd "${{ matrix.plugin.folder }}"
          zip -r "../${{ matrix.plugin.zip }}" . -x "*.zip"

      - name: Generate SHA256
        id: sha256
        run: echo "hash=$(sha256sum ${{ matrix.plugin.zip }} | awk '{print $1}')" >> $GITHUB_OUTPUT

      - name: Update index.yml
        env:
          PLUGIN_ID: ${{ matrix.plugin.id }}
          VERSION: ${{ steps.version.outputs.version }}-${{ steps.hash.outputs.sha }}
          ZIP: ${{ matrix.plugin.zip }}
          SHA: ${{ steps.sha256.outputs.hash }}
        run: |
          export DATE=$(date -u '+%Y-%m-%d %H:%M:%S')
          python3 .github/workflows/update_index.py

      - name: Update version in plugin yml
        env:
          VERSION: ${{ steps.version.outputs.version }}-${{ steps.hash.outputs.sha }}
          PLUGIN_YML: ${{ matrix.plugin.yml }}
        run: |
          sed -i "s/^version:.*/version: \"${VERSION}\"/" "${PLUGIN_YML}"

      - name: Commit and push
        env:
          ZIP: ${{ matrix.plugin.zip }}
          PLUGIN_YML: ${{ matrix.plugin.yml }}
          VERSION: ${{ steps.version.outputs.version }}-${{ steps.hash.outputs.sha }}
          PLUGIN_ID: ${{ matrix.plugin.id }}
        run: |
          git add "${ZIP}" index.yml "${PLUGIN_YML}"
          git commit -m "ci: auto-package ${PLUGIN_ID} v${VERSION}" || echo "Nothing to commit"
          # Retry push in case of concurrent matrix jobs
          for i in 1 2 3; do
            git push && break
            echo "Push failed, pulling and retrying ($i/3)..."
            git pull --rebase origin main
            sleep 2
          done
