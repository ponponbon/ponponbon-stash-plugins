name: package-plugin

on:
  push:
    branches:
      - main
    paths:
      - 'merge_multipart_vr/**'
      - 'extrafanart_gallery/**'

jobs:
  package:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, 'ci: auto-package')"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get short hash
        id: hash
        run: echo "sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Detect changed plugin
        id: plugin
        run: |
          CHANGED=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || git diff --name-only HEAD)
          if echo "$CHANGED" | grep -q '^merge_multipart_vr/'; then
            echo "folder=merge_multipart_vr" >> $GITHUB_OUTPUT
            echo "id=merge_multipart" >> $GITHUB_OUTPUT
            echo "zip=merge_multipart.zip" >> $GITHUB_OUTPUT
            echo "yml=merge_multipart_vr/merge_multipart_vr.yml" >> $GITHUB_OUTPUT
          elif echo "$CHANGED" | grep -q '^extrafanart_gallery/'; then
            echo "folder=extrafanart_gallery" >> $GITHUB_OUTPUT
            echo "id=extrafanart_gallery" >> $GITHUB_OUTPUT
            echo "zip=extrafanart_gallery.zip" >> $GITHUB_OUTPUT
            echo "yml=extrafanart_gallery/extrafanart_gallery.yml" >> $GITHUB_OUTPUT
          else
            echo "No recognised plugin folder changed, exiting."
            exit 0
          fi

      - name: Get and increment version
        id: version
        run: |
          CURRENT=$(grep '^version:' "${{ steps.plugin.outputs.yml }}" | sed 's/version: *//' | tr -d '"' | cut -d'-' -f1)
          MAJOR=$(echo $CURRENT | cut -d'.' -f1)
          MINOR=$(echo $CURRENT | cut -d'.' -f2)
          PADLEN=${#MINOR}
          MINOR=$((10#$MINOR + 1))
          NEW_MINOR=$(printf "%0${PADLEN}d" $MINOR)
          echo "version=${MAJOR}.${NEW_MINOR}" >> $GITHUB_OUTPUT

      - name: Zip plugin
        run: |
          cd "${{ steps.plugin.outputs.folder }}"
          zip -r "../${{ steps.plugin.outputs.zip }}" ./*

      - name: Generate SHA256
        id: sha256
        run: echo "hash=$(sha256sum ${{ steps.plugin.outputs.zip }} | awk '{print $1}')" >> $GITHUB_OUTPUT

      - name: Update index.yml
        env:
          PLUGIN_ID: ${{ steps.plugin.outputs.id }}
          VERSION: ${{ steps.version.outputs.version }}-${{ steps.hash.outputs.sha }}
          ZIP: ${{ steps.plugin.outputs.zip }}
          SHA: ${{ steps.sha256.outputs.hash }}
        run: |
          export DATE=$(date -u '+%Y-%m-%d %H:%M:%S')
          python3 .github/workflows/update_index.py

      - name: Update version in plugin yml
        env:
          VERSION: ${{ steps.version.outputs.version }}-${{ steps.hash.outputs.sha }}
          PLUGIN_YML: ${{ steps.plugin.outputs.yml }}
        run: |
          sed -i "s/^version:.*/version: \"${VERSION}\"/" "${PLUGIN_YML}"

      - name: Commit and push
        env:
          ZIP: ${{ steps.plugin.outputs.zip }}
          PLUGIN_YML: ${{ steps.plugin.outputs.yml }}
          VERSION: ${{ steps.version.outputs.version }}-${{ steps.hash.outputs.sha }}
        run: |
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"
          git add "${ZIP}" index.yml "${PLUGIN_YML}"
          git commit -m "ci: auto-package v${VERSION}" || echo "Nothing to commit"
          git push